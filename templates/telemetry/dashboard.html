{% load static %}
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>AIAERO CONNECT ‚Äì Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="{% static 'css/dashboard.css' %}" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #0b0f19;
      color: #fff;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    .sidebar {
      width: 260px;
      background: #111520;
      border-right: 1px solid #222933;
      padding-top: 20px;
      display: flex;
      flex-direction: column;
    }
    .sidebar-logo {
      text-align: center;
      margin-bottom: 25px;
    }
    .sidebar-logo img {
      width: 80px;
      opacity: 0.95;
    }
    .sidebar h2 {
      text-align: center;
      margin-top: 5px;
      font-size: 18px;
      font-weight: 600;
    }
    .nav-links {
      flex-grow: 1;
      padding: 10px 0;
    }
    .nav-links a {
      display: block;
      padding: 12px 22px;
      margin: 6px 12px;
      text-decoration: none;
      background: #1a2130;
      color: #e4e4e4;
      border-radius: 8px;
      font-size: 14px;
      transition: 0.2s;
    }
    .nav-links a:hover {
      background: #0056ff;
      color: #fff;
    }
    .main {
      flex-grow: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    .top-bar-left .title {
      font-size: 22px;
      margin-bottom: 4px;
      font-weight: 600;
    }
    .top-bar-left small {
      opacity: 0.8;
    }

    /* --- profile dropdown on right side --- */
    .top-bar-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .profile-wrapper {
      position: relative;
    }
    .profile-chip {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 999px;
      background: #111520;
      border: 1px solid #222933;
      font-size: 13px;
      color: #f9fafb;
      cursor: pointer;
      outline: none;
    }
    .profile-chip:hover {
      background: #141b2a;
    }
    .avatar-circle {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: #0056ff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }
    .profile-name {
      font-weight: 500;
    }
    .profile-arrow {
      font-size: 10px;
      opacity: 0.8;
    }

    .profile-dropdown {
      position: absolute;
      right: 0;
      top: 110%;
      min-width: 160px;
      background: #111520;
      border-radius: 12px;
      border: 1px solid #222933;
      box-shadow: 0 12px 30px rgba(0,0,0,0.6);
      padding: 6px 0;
      display: none;
      z-index: 1000;
    }
    .profile-wrapper.open .profile-dropdown {
      display: block;
    }
    .profile-dropdown a {
      display: block;
      padding: 8px 14px;
      font-size: 13px;
      color: #e4e4e4;
      text-decoration: none;
    }
    .profile-dropdown a:hover {
      background: #1f2937;
    }

    .login-btn {
      color: #a0b4ff;
      text-decoration: none;
      font-size: 13px;
    }
    .login-btn:hover {
      text-decoration: underline;
    }

    #liveMap {
      height: 600px;
      border-radius: 14px;
      overflow: hidden;
      position: relative;
      margin-top: 4px;
    }
    .map-badge {
      position: absolute;
      right: 12px;
      top: 12px;
      z-index: 500;
      background: rgba(0,0,0,.45);
      color: #fff;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
    }
    .leaflet-control-attribution { display: none !important; }
    .leaflet-tooltip.device-label {
      background: rgba(0,0,0,.65);
      color: #fff;
      border: none;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 11px;
    }
    /* Distance overlay panel */
    .distance-panel {
      position: absolute;
      left: 12px;
      bottom: 12px;
      z-index: 600;
      background: rgba(0,0,0,0.72);
      color: #fff;
      padding: 8px 12px;
      border-radius: 10px;
      font-size: 11px;
      max-width: 260px;
      line-height: 1.4;
      display: none;
    }
    .distance-panel b { display: block; margin-bottom: 4px; }
    .distance-panel .line { white-space: nowrap; }
    .leaflet-tooltip.distance-label {
      background: rgba(0,0,0,0.75);
      color: #fff;
      border-radius: 999px;
      padding: 2px 6px;
      border: none;
      font-size: 10px;
    }
  </style>
</head>

<body>
  <div class="sidebar">
    <div class="sidebar-logo">
      <img src="{% static 'img/Aiaero_logo.png' %}">
      <h2>AIAERO CONNECT</h2>
    </div>
    <div class="nav-links">
      <a href="{% url 'dashboard' %}">üìç Live Dashboard</a>
      <a href="{% url 'tracking_page' %}">üõ∞ Tracking System</a>
      <a href="{% url 'person_auto' %}">üë§ Device Details</a>
    </div>
  </div>

  <div class="main">
    <div class="top-bar">
      <div class="top-bar-left">
        <div class="title">Live Device Connections</div>
        <small id="liveCount">Loading‚Ä¶</small>
      </div>

      <div class="top-bar-right">
        {% if user.is_authenticated %}
          <div class="profile-wrapper" id="profileWrapper">
            <button type="button" class="profile-chip" id="profileToggle">
              <div class="avatar-circle">
                {{ user.username|first|upper }}
              </div>
              <span class="profile-name">{{ user.username }}</span>
              <span class="profile-arrow">‚ñº</span>
            </button>
            <div class="profile-dropdown">
              <a href="{% url 'account' %}">My account</a>
              <a href="{% url 'logout' %}">Logout</a>
            </div>
          </div>
        {% else %}
          <a href="{% url 'login' %}" class="login-btn">Login</a>
        {% endif %}
      </div>
    </div>

    <div id="liveMap">
      <div id="mapBadge" class="map-badge">Loading‚Ä¶</div>
      <div id="distancePanel" class="distance-panel"></div>
    </div>
  </div>

  <script>
    const API_URL = `/api/current/recent/?active_minutes=180`;

    let map;
    let markers = {};
    let lastItems = [];
    let labelsById = {};
    let distanceLines = [];
    let distanceTooltips = [];
    let lastRefId = null;

    // ---------------- Map init ----------------
    function initMap() {
      if (map) return;
      map = L.map('liveMap', { zoomControl: true, attributionControl: false })
        .setView([13.1266, 80.1002], 15);

      L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
      }).addTo(map);
    }

    // ---------------- Distance util ----------------
    function haversineMeters(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const toRad = x => x * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lat2 - lon1);
      const a =
        Math.sin(dLat/2)**2 +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
        Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }
    function formatDistance(m) {
      if (!isFinite(m)) return '';
      return m < 1000 ? `${Math.round(m)} m` : `${(m/1000).toFixed(2)} km`;
    }

    // ---------------- Clear distances ----------------
    function clearDistanceHighlights() {
      distanceLines.forEach(l => map.removeLayer(l));
      distanceTooltips.forEach(t => map.removeLayer(t));
      distanceLines = [];
      distanceTooltips = [];
      const panel = document.getElementById('distancePanel');
      panel.style.display = 'none';
      panel.innerHTML = '';
    }

    // ---------------- Highlight distances ----------------
    function highlightDistancesFor(deviceId) {
      clearDistanceHighlights();
      const refMarker = markers[deviceId];
      if (!refMarker) return;

      const refLatLng = refMarker.getLatLng();
      const refLabel = labelsById[deviceId] || deviceId;
      const distances = [];

      Object.entries(markers).forEach(([otherId, marker]) => {
        if (otherId === deviceId) return;
        const otherLatLng = marker.getLatLng();
        const dM = haversineMeters(
          refLatLng.lat, refLatLng.lng,
          otherLatLng.lat, otherLatLng.lng
        );
        distances.push({ otherId, otherLatLng, distM: dM });
      });

      if (!distances.length) return;
      distances.sort((a,b) => a.distM - b.distM);

      distances.forEach(d => {
        const line = L.polyline(
          [refLatLng, d.otherLatLng],
          { color: '#00e5ff', weight: 2, dashArray: '4 6', opacity: 0.7 }
        ).addTo(map);
        distanceLines.push(line);

        const midLat = (refLatLng.lat + d.otherLatLng.lat)/2;
        const midLng = (refLatLng.lng + d.otherLatLng.lng)/2;
        const midMarker = L.marker([midLat, midLng], { opacity: 0, interactive: false })
          .addTo(map)
          .bindTooltip(formatDistance(d.distM), {
            permanent: true, direction: 'center', className: 'distance-label'
          });
        distanceTooltips.push(midMarker);
      });

      // panel
      const panel = document.getElementById('distancePanel');
      let html = `<b>${refLabel}</b>`;
      distances.forEach(d => {
        const lbl = labelsById[d.otherId] || d.otherId;
        html += `<div class="line">${refLabel} ‚Üí ${lbl} ‚Äî ${formatDistance(d.distM)}</div>`;
      });
      panel.innerHTML = html;
      panel.style.display = 'block';
    }

    // ---------------- Add marker ----------------
    function addMarker(device) {
      const id = device.device_id || device.label || "Unknown";
      let lat = parseFloat(device.lat);
      let lon = parseFloat(device.lon);
      const label = device.label || id;

      if (!lat || !lon || isNaN(lat) || isNaN(lon)) {
        lat = 13.1266 + Math.random()/1000;
        lon = 80.1002 + Math.random()/1000;
      }

      const isReceiver = id.startsWith("RX");
      const iconColor = isReceiver ? "red" : "blue";
      const icon = L.icon({
        iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${iconColor}.png`,
        shadowUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-shadow.png",
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      });

      if (markers[id]) {
        markers[id].setLatLng([lat, lon]);
      } else {
        const m = L.marker([lat, lon], { icon }).addTo(map);
        m.bindTooltip(label, {
          permanent: true, direction: 'top', offset: [0,-30], className: 'device-label'
        });
        m.bindPopup(
          `<b>${label}</b><br>Lat: ${lat.toFixed(6)}<br>Lon: ${lon.toFixed(6)}<br>` +
          `<a href="/person/${id}/" style="color:#00e5ff;">View Details ‚Üí</a>`
        );

        // show while hovering, hide when leaving
        m.on('mouseover', () => {
          lastRefId = id;
          highlightDistancesFor(id);
        });
        m.on('mouseout', () => {
          lastRefId = null;
          clearDistanceHighlights();
        });

        markers[id] = m;
      }
    }

    // ---------------- Refresh ----------------
    async function refresh() {
      try {
        const res = await fetch(API_URL, { cache: 'no-store' });
        if (!res.ok) throw new Error(res.status);
        const data = await res.json();
        const items = data.items || [];

        lastItems = items;
        labelsById = {};
        items.forEach(d => {
          const id = d.device_id || d.label || "Unknown";
          labelsById[id] = d.label || id;
        });

        document.getElementById('liveCount').textContent = `${items.length} device(s) connected`;
        document.getElementById('mapBadge').textContent = `${items.length} device(s) connected`;

        items.forEach(addMarker);

        const coords = Object.values(markers).map(m => m.getLatLng());
        if (coords.length > 0) {
          const bounds = L.latLngBounds(coords);
          map.fitBounds(bounds.pad(0.3));
        }

        if (lastRefId && markers[lastRefId]) highlightDistancesFor(lastRefId);
      } catch (err) {
        console.error("Error fetching data:", err);
        document.getElementById('liveCount').textContent = "Error fetching data";
        document.getElementById('mapBadge').textContent = "Error fetching data";
        clearDistanceHighlights();
      }
    }

    // ---------------- Init ----------------
    window.addEventListener("load", () => {
      initMap();
      refresh();
      setInterval(refresh, 5000);

      // profile dropdown behaviour
      const wrapper = document.getElementById("profileWrapper");
      const toggle = document.getElementById("profileToggle");
      if (wrapper && toggle) {
        toggle.addEventListener("click", (e) => {
          e.stopPropagation();
          wrapper.classList.toggle("open");
        });
        document.addEventListener("click", () => {
          wrapper.classList.remove("open");
        });
      }
    });
  </script>
</body>
</html>
